openapi: 3.0.3
info:
  title: Driver API
  version: "1.0.0"
  description: Driver-facing endpoints for authentication, jobs, check-calls, and live location.
servers:
  - url: https://api.example.com
    description: Production
  - url: https://staging.api.example.com
    description: Staging
components:
  securitySchemes:
    BearerToken:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Error:
      type: object
      properties:
        message:
          type: string
    DriverAuthResponse:
      type: object
      properties:
        token:
          type: string
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        expires_at:
          type: string
          format: date-time
    LoadStop:
      type: object
      properties:
        id:
          type: integer
        sequence:
          type: integer
        type:
          type: string
          enum: [pickup, delivery]
        facility_name:
          type: string
        address:
          type: string
        city:
          type: string
        state:
          type: string
        zip:
          type: string
        country:
          type: string
        lat:
          type: number
          format: float
        lng:
          type: number
          format: float
        date_from:
          type: string
          format: date-time
        date_to:
          type: string
          format: date-time
        timezone:
          type: string
    DriverJob:
      type: object
      properties:
        id:
          type: integer
        load_number:
          type: string
        status:
          type: string
          enum: [draft, posted, assigned, in_transit, delivered, completed, cancelled]
        route_status:
          type: string
        last_lat:
          type: number
          format: float
        last_lng:
          type: number
          format: float
        last_location_at:
          type: string
          format: date-time
        last_eta_minutes:
          type: integer
        stops:
          type: array
          items:
            $ref: '#/components/schemas/LoadStop'
    CheckCallCreate:
      type: object
      required: [load_id, status]
      properties:
        load_id:
          type: integer
        stop_id:
          type: integer
        status:
          type: string
        event_code:
          type: string
          description: Suggested codes like ARR_PICKUP, DEP_PICKUP, ARR_DELIVERY, DEP_DELIVERY, ISSUE_DELAY
        note:
          type: string
        document:
          type: string
          format: binary
    LocationPing:
      type: object
      required: [load_id, lat, lng]
      properties:
        load_id:
          type: integer
        load_number:
          type: string
        lat:
          type: number
          format: float
          minimum: -90
          maximum: 90
        lng:
          type: number
          format: float
          minimum: -180
          maximum: 180
        speed:
          type: number
          format: float
          minimum: 0
          maximum: 200
        heading:
          type: number
          format: float
          minimum: 0
          maximum: 360
        accuracy_m:
          type: number
          format: float
          minimum: 0
        source:
          type: string
          example: gps
        track_id:
          type: string
        recorded_at:
          type: string
          format: date-time
    LocationResponse:
      type: object
      properties:
        message:
          type: string
        id:
          type: integer
        eta_minutes:
          type: integer
        ignored:
          type: boolean
        reason:
          type: string
paths:
  /api/driver/auth:
    post:
      summary: Authenticate driver by ID and phone
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [driver_id, phone]
              properties:
                driver_id:
                  type: integer
                phone:
                  type: string
      responses:
        '200':
          description: Token issued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DriverAuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /api/driver/token:
    post:
      summary: Rotate/refresh driver token
      security:
        - BearerToken: []
      responses:
        '200':
          description: Token rotated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DriverAuthResponse'
        '401':
          description: Unauthorized
  /api/driver/jobs:
    get:
      summary: List assigned jobs for authenticated driver
      security:
        - BearerToken: []
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                properties:
                  loads:
                    type: array
                    items:
                      $ref: '#/components/schemas/DriverJob'
        '401':
          description: Unauthorized
  /api/driver/jobs/{loadId}/status:
    post:
      summary: Update driver-facing status for a load
      security:
        - BearerToken: []
      parameters:
        - in: path
          name: loadId
          schema:
            type: integer
          required: true
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  description: accept, reject, en_route, on_site, completed, issue_*
                note:
                  type: string
                document:
                  type: string
                  format: binary
      responses:
        '200':
          description: Status recorded
        '401':
          description: Unauthorized
        '403':
          description: Not assigned to load
  /api/driver/check-calls:
    post:
      summary: Submit a check-call
      security:
        - BearerToken: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: '#/components/schemas/CheckCallCreate'
      responses:
        '201':
          description: Created
        '401':
          description: Unauthorized
  /api/driver/location:
    post:
      summary: Send live location ping
      security:
        - BearerToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LocationPing'
      responses:
        '201':
          description: Stored immediately
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '202':
          description: Accepted (queued or ignored)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LocationResponse'
        '401':
          description: Unauthorized
  /api/driver/eta:
    post:
      summary: Submit updated ETA (optional)
      security:
        - BearerToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [load_id, eta_minutes]
              properties:
                load_id:
                  type: integer
                eta_minutes:
                  type: integer
      responses:
        '200':
          description: ETA updated
        '401':
          description: Unauthorized
security:
  - BearerToken: []
